#:kivy 1.9.1

<ScreenManagement>:
    id: _sm
    ignition_input: app.arduino.ignition_input
    reverse_input: app.arduino.reverse_input
    Screen:
        name: 'off_screen'
    MainScreen:
        name: 'main_screen'
        sm: _sm
    CameraScreen:
        name: 'camera_screen'
        sm: _sm
    PasscodeScreen:
        name: 'passcode_screen'
        sm: _sm

<MainScreen>:
    id: main_screen
    dynamic_layout: dynamic_layout

    DynamicLayout:
        id: dynamic_layout
        indicator_layout: indicator_layout
        button_layout: button_layout
        indicator_edit_popup: indicator_edit_popup
        button_edit_popup: button_edit_popup
        modify_mode: False
        on_parent: if self.parent == main_screen: self.parent.remove_widget(self)

    TabbedPanel:
        id: main_tabbed_panel
        do_default_tab: False

        TabbedPanelItem:
            text: 'Home'
            id: home_tab

            BoxLayout:
                id: main_layout
                orientation: 'horizontal'
                padding: 10

                GridLayout:
                    id: indicator_layout
                    cols: 1
                    spacing: 5
                    padding: 5
                    size_hint_x: 0.25

                GridLayout:
                    id: button_layout
                    cols: 3
                    rows: 2
                    spacing: 5
                    padding: 5
                    size_hint_x: 0.75

        TabbedPanelItem:
            text: 'Settings'
            id: settings_tab

            RelativeLayout:
                id: settings_layout
                size_hint_x: None
                width: 124

                BoxLayout:
                    orientation: 'vertical'
                    padding: 10
                    spacing: 5

                    Label:
                        text: 'Screen\nBrightness'
                        markup: True
                        size_hint_y: 0.1
                        text_size: self.size
                        halign: 'center'
                        valign: 'middle'

                    Slider:
                        id: screen_light_slider
                        on_touch_move: app.brightness(self.value)
                        orientation: 'vertical'
                        min: 20
                        max: 200
                        value: 200
                        size_hint_y: 0.9

                ToggleButton:
                    id: modify_screen
                    text: 'Modify Screen'
                    size_hint: 0.1, 1
                    on_press:
                        if self.state == 'down': dynamic_layout.modify_screen()
                        else: dynamic_layout.end_modify()

                Button:
                    id: exit_button
                    on_press: app.exit_app()
                    text: 'X'
                    size_hint: None, None
                    size: 20, 20
                    right: root.right

    IndicatorEditPopup:
        id: indicator_edit_popup
        ind_label_input: ind_label_input
        ind_channel_spinner: ind_channel_spinner
        dynamic_layout: dynamic_layout
        modify_mode: dynamic_layout.modify_mode
        title: "Change Indicator Label"
        size_hint: None, None
        size: 300, 250
        pos_hint: {'middle': 1, 'top': 1}
        on_parent: if self.parent == main_screen: self.parent.remove_widget(self)

        BoxLayout:
            orientation: 'vertical'
            spacing: 5
            padding: 5

            TextInput:
                id: ind_label_input
                size_hint: 1, .35

            BoxLayout:
                orientation: 'horizontal'
                size_hint: 1, .25

                Label:
                    text: 'Channel:'
                    size_hint: .3, 1

                Spinner:
                    id: ind_channel_spinner
                    size_hint: .7, 1
                    text: '0'
                    values: ('0', '1', '2', '3', '4', '5')

            GridLayout:
                rows: 1
                cols: 2
                size_hint: 1, .4
                spacing: 5

                Button:
                    text: 'OK'
                    on_press: indicator_edit_popup.save_indicator()

                Button:
                    text: 'Cancel'
                    on_press: indicator_edit_popup.dismiss()

    ButtonEditPopup:
        id: button_edit_popup
        label_input: label_input
        toggle_check: toggle_check
        channel_spinner: channel_spinner
        dynamic_layout: dynamic_layout
        modify_mode: dynamic_layout.modify_mode
        title: "Change Button Label"
        size_hint: None, None
        size: 300, 250
        pos_hint: {'middle': 1, 'top': 1}
        on_parent: if self.parent == main_screen: self.parent.remove_widget(self)

        BoxLayout:
            orientation: 'vertical'
            spacing: 5
            padding: 5

            TextInput:
                id: label_input
                size_hint: 1, 0.3

            BoxLayout:
                orientation: 'horizontal'
                size_hint: 1, .2

                Label:
                    text: 'Toggle?:'
                    size_hint: .3, 1

                CheckBox:
                    id: toggle_check
                    size_hint: .7, 1

            BoxLayout:
                orientation: 'horizontal'
                size_hint: 1, .2

                Label:
                    text: 'Channel:'
                    size_hint: .3, 1

                Spinner:
                    id: channel_spinner
                    size_hint: .7, 1
                    text: '0'
                    values: ('0', '1', '2', '3', '4', '5')

            GridLayout:
                rows: 1
                cols: 2
                size_hint: 1, 0.3
                spacing: 5

                Button:
                    text: 'OK'
                    on_press: button_edit_popup.save_button()

                Button:
                    text: 'Cancel'
                    on_press: button_edit_popup.dismiss()


<IndicatorButton, DynToggleButton, DynButton>:
    text_size: self.size
    font_size: '18sp'
    halign: 'center'
    valign: 'middle'

<PasscodeScreen>:
    id: passcode_screen
    fail_popup: fail_popup.__self__

    GridLayout:
        cols: 3
        rows: 4
        spacing: 5
        padding: 5
        size_hint_x: None
        width: 400
        pos: 200, 0

        Button:
            text: '7'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '8'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '9'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '4'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '5'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '6'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '1'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '2'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '3'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '0'
            on_release: root.sm.try_passcode(self.text)

    Popup:
        id: fail_popup
        title: "Invalid Passcode"
        size_hint: None, None
        size: 150, 150
        on_parent: if self.parent == passcode_screen: self.parent.remove_widget(self)

        BoxLayout:
            orientation: 'vertical'
            padding: 5

            Button:
                text: 'Try Again'
                on_release: fail_popup.dismiss()

<CameraScreen>:
    id: camera_screen
    reverse_input: app.arduino.reverse_input




