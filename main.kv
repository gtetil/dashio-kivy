#:kivy 1.9.1

<ScreenManagement>:
    id: _sm
    ignition_input: app.arduino.ignition_input
    reverse_input: app.arduino.reverse_input
    Screen:
        name: 'off_screen'
    MainScreen:
        name: 'main_screen'
        sm: _sm
    CameraScreen:
        name: 'camera_screen'
        sm: _sm
    PasscodeScreen:
        name: 'passcode_screen'
        sm: _sm

<MainScreen>:
    id: main_screen
    dynamic_layout: dynamic_layout

    Button:
        id: end_modify_button
        on_press: dynamic_layout.end_modify(); self.parent.remove_widget(self)
        text: 'End Screen Modify'
        color: 0.88, 0.72, 0.1, 1
        size_hint: None, None
        size: 150, 42
        right: root.right - 226
        top: root.top - 2
        on_parent: if self.parent == main_screen: self.parent.remove_widget(self)

    DynamicLayout:
        id: dynamic_layout
        indicator_layout: indicator_layout
        button_layout: button_layout
        item_edit_popup: item_edit_popup
        modify_mode: False
        on_parent: if self.parent == main_screen: self.parent.remove_widget(self)

    TabbedPanel:
        id: main_tabbed_panel
        do_default_tab: False

        TabbedPanelItem:
            text: 'Home'
            id: home_tab

            BoxLayout:
                id: main_layout
                orientation: 'horizontal'
                padding: 10

                GridLayout:
                    id: indicator_layout
                    cols: 1
                    spacing: 5
                    padding: 5
                    size_hint_x: 0.25

                GridLayout:
                    id: button_layout
                    cols: 3
                    rows: 2
                    spacing: 5
                    padding: 5
                    size_hint_x: 0.75

        TabbedPanelItem:
            text: 'Settings'
            id: settings_tab

            RelativeLayout:
                id: settings_layout

                BoxLayout:
                    id: settings_box_layout
                    orientation: 'horizontal'
                    padding: 10
                    spacing: 5

                    BoxLayout:
                        id: backlight_layout
                        orientation: 'vertical'
                        size_hint_x: 0.2
                        padding: 10
                        spacing: 5

                        Label:
                            text: 'Screen\nBrightness'
                            markup: True
                            size_hint_y: 0.1
                            text_size: self.size
                            halign: 'center'
                            valign: 'middle'

                        Slider:
                            id: screen_light_slider
                            on_touch_move: app.brightness(self.value)
                            orientation: 'vertical'
                            min: 20
                            max: 200
                            value: 200
                            size_hint_y: 0.9

                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_x: 0.2
                        padding: 10
                        spacing: 15

                        Button:
                            id: modify_screen
                            text: 'Modify\n Main Screen'
                            halign: 'center'
                            valign: 'middle'
                            size_hint_y: 0.15
                            on_press: if not dynamic_layout.modify_mode: enter_modify_popup.open()

                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: 0.17
                            padding: 5, 0, 0, 0

                            Label:
                                text: 'Screen Off Delay:'

                            BoxLayout:
                                orientation: 'horizontal'

                                TextInput:
                                    text: '30'
                                    size_hint_x: 0.4

                                Label:
                                    text: 'seconds'
                                    size_hint_x: 0.6

                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: 0.17
                            padding: 5, 0, 0, 0

                            Label:
                                text: 'Password Disable:'

                            Switch:

                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: 0.53

                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_x: 0.6
                        padding: 10
                        spacing: 5

                Button:
                    id: exit_button
                    on_press: app.exit_app()
                    text: 'X'
                    size_hint: None, None
                    size: 20, 20
                    right: root.right

        Popup:
            id: enter_modify_popup
            title: "Modify Main Screen"
            size_hint: None, None
            size: 275, 250
            pos_hint: {'middle': 1, 'center': 1}
            on_parent:
                if self.parent == settings_tab: self.parent.remove_widget(self)

            BoxLayout:
                orientation: 'vertical'

                Label:
                    text: 'Entering Modify Main Screen will turn off all outputs.  Proceed?'
                    size_hint: 1, .7
                    height: self.texture_size[1]
                    font_size: '18sp'
                    text_size: self.size
                    halign: 'center'
                    valign: 'middle'

                GridLayout:
                    rows: 1
                    cols: 2
                    size_hint: 1, .3

                    Button:
                        text: 'Yes'
                        on_release: enter_modify_popup.dismiss(); dynamic_layout.modify_screen(); main_tabbed_panel.switch_to(home_tab); root.add_widget(end_modify_button)

                    Button:
                        text: 'Cancel'
                        on_release: enter_modify_popup.dismiss()


    ScreenItemEditPopup:
        id: item_edit_popup
        label_input: label_input
        toggle_check: toggle_check
        enable_check: enable_check
        channel_spinner: channel_spinner
        toggle_layout: toggle_layout
        dynamic_layout: dynamic_layout
        modify_mode: dynamic_layout.modify_mode
        title: "Modify"
        size_hint: None, None
        size: 300, 250
        pos_hint: {'middle': 1, 'top': 1}
        on_parent: if self.parent == main_screen: self.parent.remove_widget(self)

        BoxLayout:
            orientation: 'vertical'
            spacing: 5
            padding: 5

            GridLayout:
                rows: 2
                cols: 2
                size_hint: 1, 0.43
                spacing: 5

                BoxLayout:
                    orientation: 'horizontal'

                    Label:
                        text: 'Enable?:'
                        size_hint: .6, 1

                    CheckBox:
                        id: enable_check
                        size_hint: .4, 1

                BoxLayout:
                    id: toggle_layout
                    orientation: 'horizontal'

                    Label:
                        text: 'Toggle?:'
                        size_hint: .6, 1

                    CheckBox:
                        id: toggle_check
                        size_hint: .4, 1

                BoxLayout:
                    orientation: 'horizontal'

                    Label:
                        text: 'Channel:'
                        size_hint: .6, 1

                    Spinner:
                        id: channel_spinner
                        size_hint: .4, 1
                        text: '0'
                        values: ('0', '1', '2', '3', '4', '5')

            TextInput:
                id: label_input
                size_hint: 1, 0.27

            GridLayout:
                rows: 1
                cols: 2
                size_hint: 1, 0.3
                spacing: 5

                Button:
                    text: 'OK'
                    on_press: item_edit_popup.save_item()

                Button:
                    text: 'Cancel'
                    on_press: item_edit_popup.dismiss()


<IndicatorButton, DynToggleButton, DynButton>:
    text_size: self.size
    font_size: '18sp'
    halign: 'center'
    valign: 'middle'

<DynToggleButton, DynButton>:
    app_ref: app
    ignition_input: app.arduino.ignition_input

<IndicatorButton>:
    digital_inputs: app.arduino.digital_inputs


<PasscodeScreen>:
    id: passcode_screen
    fail_popup: fail_popup.__self__

    GridLayout:
        cols: 3
        rows: 4
        spacing: 5
        padding: 5
        size_hint_x: None
        width: 400
        pos: 200, 0

        Button:
            text: '7'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '8'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '9'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '4'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '5'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '6'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '1'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '2'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '3'
            on_release: root.sm.try_passcode(self.text)
        Button:
            text: '0'
            on_release: root.sm.try_passcode(self.text)

    Popup:
        id: fail_popup
        title: "Invalid Passcode"
        size_hint: None, None
        size: 150, 150
        on_parent: if self.parent == passcode_screen: self.parent.remove_widget(self)

        BoxLayout:
            orientation: 'vertical'
            padding: 5

            Button:
                text: 'Try Again'
                on_release: fail_popup.dismiss()

<CameraScreen>:
    id: camera_screen
    reverse_input: app.arduino.reverse_input




